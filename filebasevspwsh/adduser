#!/usr/bin/env dotnet
#:package Microsoft.Data.SqlClient@7.0.0-preview2.25289.6
#:package System.CommandLine@2.0.0
using Microsoft.Data.SqlClient;
using System.CommandLine;
using System.Data;

// File-based top-level app that reads new user from command-line arguments
// and inserts into Users (namn, efternamn, isadmin, isactive) using ADO.NET.
// No external packages required.




Option<string> serverOptions = new("--server")
{
    Description = "",
    DefaultValueFactory = parseResult => "localhost"
};

Option<string> databaseOptions = new("--database")
{
    Description = "",
    DefaultValueFactory = parseResult => "MytestDb"
};

Option<string> sqlUserOptions = new("--sqluser")
{
    Description = "",
    DefaultValueFactory = parseResult => "sa"
};

Option<string> sqlPasswordOptions = new("--sqlpass")
{
    Description = "",
    DefaultValueFactory = parseResult => "StrongP@ssword"
};

Option<string> firstNameOptions = new("--user-firstname")
{
    Description = "",
    Required = true
};

firstNameOptions.Validators.Add(result =>
{
    if (string.IsNullOrEmpty(result.GetValue(firstNameOptions)))
    {
        result.AddError("Required");
    }
});

Option<string> lastNameOptions = new("--user-lastname")
{
    Description = "",
    Required = true
};

lastNameOptions.Validators.Add(result =>
{
    if (string.IsNullOrEmpty(result.GetValue(lastNameOptions)))
    {
        result.AddError("Required");
    }
});

Option<byte> isAdminOptions = new("--user-isadmin")
{
    Description = "",
    DefaultValueFactory = parseResult => 0
};

Option<byte> isActiveOptions = new("--user-isactive")
{
    Description = "",
    DefaultValueFactory = parseResult => 1
};

RootCommand rootCommand = new("Sample app for System.CommandLine")
{
    serverOptions,
    databaseOptions,
    sqlUserOptions,
    sqlPasswordOptions,
    firstNameOptions,
    lastNameOptions,
    isAdminOptions,
    isActiveOptions
};


ParseResult parseResult = rootCommand.Parse(args);


if (parseResult.Errors.Count > 0)
{
    foreach (var error in parseResult.Errors)
    {
        Console.ForegroundColor = ConsoleColor.Red;
        Console.Error.WriteLine("Fel vid inläsning av argument: " + error.Message);
        Console.ResetColor();

    }

    rootCommand.Parse("-h").Invoke();

    return 1;
}

return CreateUser(
    parseResult.GetValue(serverOptions) ?? "",
    parseResult.GetValue(databaseOptions) ?? "",
    parseResult.GetValue(sqlUserOptions) ?? "",
    parseResult.GetValue(sqlPasswordOptions) ?? "",
    parseResult.GetRequiredValue(firstNameOptions),
    parseResult.GetRequiredValue(lastNameOptions),
    parseResult.GetValue(isAdminOptions),
    parseResult.GetValue(isActiveOptions)
    );

int CreateUser(
        string server,
        string database,
        string sqlUser,
        string sqlPassword,
        string firstName,
        string lastName,
        byte isAdmin,
        byte isActive
    )
{

    // Build connection string
    string connectionString =
        $"Server={server};Database={database};User Id={sqlUser};Password={sqlPassword};TrustServerCertificate=True;";
    Console.WriteLine(connectionString);
    const string sql =
        @"
INSERT INTO [User] (namn, efternamn, isadmin, isactive)
VALUES (@namn, @efternamn, @isadmin, @isactive);
";

    try
    {
        using var conn = new SqlConnection(connectionString);
        using var cmd = new SqlCommand(sql, conn);

        // Use NVARCHAR to preserve åäö etc.
        cmd.Parameters.Add(
            new SqlParameter("@namn", SqlDbType.NVarChar, 200)
            {
                Value = (object)firstName ?? DBNull.Value,
            }
        );
        cmd.Parameters.Add(
            new SqlParameter("@efternamn", SqlDbType.NVarChar, 200)
            {
                Value = (object)lastName ?? DBNull.Value,
            }
        );
        cmd.Parameters.Add(new SqlParameter("@isadmin", SqlDbType.Int) { Value = isAdmin });
        cmd.Parameters.Add(new SqlParameter("@isactive", SqlDbType.Int) { Value = isActive });

        conn.Open();
        int rows = cmd.ExecuteNonQuery();

        if (rows > 0)
        {
            Console.ForegroundColor = ConsoleColor.Green;
            Console.WriteLine($"Lyckades: {rows} rad(er) insatta för {firstName} {lastName}.");
            Console.ResetColor();
        }
        else
        {
            Console.ForegroundColor = ConsoleColor.Yellow;
            Console.WriteLine("Inga rader insatta.");
            Console.ResetColor();
        }
    }
    catch (Exception ex)
    {
        Console.ForegroundColor = ConsoleColor.Red;
        Console.Error.WriteLine("Fel vid databasoperation: " + ex.Message);
        Console.ResetColor();
        Environment.Exit(1);
    }

    return 0;
}
